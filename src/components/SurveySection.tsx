// Custom Radio SVGs
const RadioOff = () => (
  <svg width="32" height="28" viewBox="0 0 54 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="6" width="45" height="48" rx="22.5" fill="white"/>
    <rect x="12" y="40" width="30" height="4" fill="white"/>
    <rect x="8" y="36" width="4" height="4" fill="white"/>
    <rect width="30" height="4" transform="matrix(1 0 0 -1 12 8)" fill="white"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 8 12)" fill="white"/>
    <rect x="4" y="12" width="10" height="24" fill="white"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="#B37B0D"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 36)" fill="white"/>
    <rect x="46" y="8" width="4" height="4" transform="rotate(180 46 8)" fill="#E5C179"/>
    <rect x="48" y="12" width="6" height="4" transform="rotate(180 48 12)" fill="white"/>
    <rect width="10" height="24" transform="matrix(-1 0 0 1 52 12)" fill="white"/>
    <rect x="12" width="30" height="4" fill="black"/>
    <rect x="12" y="44" width="30" height="4" fill="black"/>
    <rect x="8" y="40" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="black"/>
    <rect x="8" y="4" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 4)" fill="black"/>
    <rect x="4" y="36" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 36)" fill="black"/>
    <rect x="4" y="8" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 8)" fill="black"/>
    <rect y="12" width="4" height="24" fill="black"/>
    <rect width="4" height="24" transform="matrix(-1 0 0 1 54 12)" fill="black"/>
  </svg>
);

const RadioOn = () => (
  <svg width="32" height="28" viewBox="0 0 54 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="6" width="45" height="48" rx="22.5" fill="#D0941C"/>
    <rect x="12" y="40" width="30" height="4" fill="#B37B0D"/>
    <rect x="8" y="36" width="4" height="4" fill="#B37B0D"/>
    <rect width="30" height="4" transform="matrix(1 0 0 -1 12 8)" fill="#E5C179"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 8 12)" fill="#E5C179"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 42 12)" fill="#E5C179"/>
    <rect x="4" y="12" width="10" height="24" fill="#D0941C"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="#B37B0D"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 36)" fill="#B37B0D"/>
    <rect x="46" y="8" width="4" height="4" transform="rotate(180 46 8)" fill="#E5C179"/>
    <rect width="10" height="24" transform="matrix(-1 0 0 1 52 12)" fill="#D0941C"/>
    <rect x="12" width="30" height="4" fill="black"/>
    <rect x="12" y="44" width="30" height="4" fill="black"/>
    <rect x="8" y="40" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="black"/>
    <rect x="8" y="4" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 4)" fill="black"/>
    <rect x="4" y="36" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 36)" fill="black"/>
    <rect x="4" y="8" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 8)" fill="black"/>
    <rect y="12" width="4" height="24" fill="black"/>
    <rect width="4" height="24" transform="matrix(-1 0 0 1 54 12)" fill="black"/>
    <path d="M36.9998 14H40.3332V17.3333H36.9998V14ZM33.6665 20.6667V17.3333H36.9998V20.6667H33.6665ZM30.3332 24V20.6667H33.6665V24H30.3332ZM26.9998 27.3333H30.3332V24H26.9998V27.3333ZM23.6665 30.6667H26.9998V27.3333H23.6665V30.6667ZM20.3332 30.6667V34H23.6665V30.6667H20.3332ZM16.9998 27.3333H20.3332V30.6667H16.9998V27.3333ZM16.9998 27.3333H13.6665V24H16.9998V27.3333Z" fill="black"/>
  </svg>
);
// Custom Checkbox SVGs
const CheckboxOff = () => (
  <svg width="32" height="28" viewBox="0 0 54 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="6" width="45" height="48" rx="22.5" fill="white"/>
    <rect x="12" y="40" width="30" height="4" fill="white"/>
    <rect x="8" y="36" width="4" height="4" fill="white"/>
    <rect width="30" height="4" transform="matrix(1 0 0 -1 12 8)" fill="white"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 8 12)" fill="white"/>
    <rect x="4" y="12" width="10" height="24" fill="white"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="#B37B0D"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 36)" fill="white"/>
    <rect x="46" y="8" width="4" height="4" transform="rotate(180 46 8)" fill="#E5C179"/>
    <rect x="48" y="12" width="6" height="4" transform="rotate(180 48 12)" fill="white"/>
    <rect width="10" height="24" transform="matrix(-1 0 0 1 52 12)" fill="white"/>
    <rect x="12" width="30" height="4" fill="black"/>
    <rect x="12" y="44" width="30" height="4" fill="black"/>
    <rect x="8" y="40" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="black"/>
    <rect x="8" y="4" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 4)" fill="black"/>
    <rect x="4" y="36" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 36)" fill="black"/>
    <rect x="4" y="8" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 8)" fill="black"/>
    <rect y="12" width="4" height="24" fill="black"/>
    <rect width="4" height="24" transform="matrix(-1 0 0 1 54 12)" fill="black"/>
  </svg>
);

const CheckboxOn = () => (
  <svg width="32" height="28" viewBox="0 0 54 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="6" width="45" height="48" rx="22.5" fill="#D0941C"/>
    <rect x="12" y="40" width="30" height="4" fill="#B37B0D"/>
    <rect x="8" y="36" width="4" height="4" fill="#B37B0D"/>
    <rect width="30" height="4" transform="matrix(1 0 0 -1 12 8)" fill="#E5C179"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 8 12)" fill="#E5C179"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 42 12)" fill="#E5C179"/>
    <rect x="4" y="12" width="10" height="24" fill="#D0941C"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="#B37B0D"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 36)" fill="#B37B0D"/>
    <rect x="46" y="8" width="4" height="4" transform="rotate(180 46 8)" fill="#E5C179"/>
    <rect width="10" height="24" transform="matrix(-1 0 0 1 52 12)" fill="#D0941C"/>
    <rect x="12" width="30" height="4" fill="black"/>
    <rect x="12" y="44" width="30" height="4" fill="black"/>
    <rect x="8" y="40" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 40)" fill="black"/>
    <rect x="8" y="4" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 46 4)" fill="black"/>
    <rect x="4" y="36" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 36)" fill="black"/>
    <rect x="4" y="8" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 50 8)" fill="black"/>
    <rect y="12" width="4" height="24" fill="black"/>
    <rect width="4" height="24" transform="matrix(-1 0 0 1 54 12)" fill="black"/>
    <rect x="21" y="12" width="12" height="4" fill="black"/>
    <rect x="17" y="16" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 37 16)" fill="black"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 17 32)" fill="black"/>
    <rect x="37" y="32" width="4" height="4" transform="rotate(180 37 32)" fill="black"/>
    <rect x="13" y="20" width="4" height="4" fill="black"/>
    <rect width="4" height="4" transform="matrix(-1 0 0 1 41 20)" fill="black"/>
    <rect width="4" height="4" transform="matrix(1 0 0 -1 13 28)" fill="black"/>
    <rect x="41" y="28" width="4" height="4" transform="rotate(180 41 28)" fill="black"/>
    <rect x="21" y="32" width="12" height="4" fill="black"/>
    <path d="M21 20V16H33V20H37V28H33V32H21V28H17V20H21Z" fill="white"/>
  </svg>
);
import React, { useState, useMemo } from 'react';
import { supabase } from '../lib/supabase';
import Image from 'next/image';
import Link from "next/link";
import { useRouter } from 'next/navigation';

const questions = [
  {
    label: "Which gaming platforms do you currently use*?",
    type: "checkbox",
    name: "platforms",
    options: [
      "Steam (PC)", "Xbox (Console/PC)", "PlayStation (PS4/PS5)", "Epic Games Store", "Nintendo Switch", "Mobile Gaming (iOS/Android)", "Other"
    ],
    other: true,
  },
  {
    label: "How often do you play games*?",
    type: "radio",
    name: "frequency",
    options: ["Daily", "Several times a week", "Weekly", "Monthly", "Rarely"],
  },
  {
    label: "Do you care about achievements/trophies in games*?",
    type: "radio",
    name: "achievements",
    options: [
      "Yes, I'm an achievement hunter",
      "Somewhat, I like unlocking them",
      "Not really, but I notice them",
      "No, I ignore them completely"
    ],
  },
  {
    label: "Have you ever felt frustrated that your gaming achievements are scattered across different platforms*?",
    type: "radio",
    name: "frustrated",
    options: ["Yes, all the time!", "Sometimes", "Rarely", "Never thought about it"],
  },
  {
    label: "Would you like to show off ALL your gaming achievements in one place, regardless of their platform*?",
    type: "radio",
    name: "showoff",
    options: ["Absolutely!", "Maybe, sounds interesting", "Not sure", "No, I'm fine with separate platforms"],
  },
  {
    label: "How interested are you in a platform that combines all your gaming achievements into one blockchain-secured profile*?",
    type: "radio",
    name: "interest",
    options: [
      "Very interested - I'd use this immediately",
      "Interested - I'd try it out",
      "Neutral - might check it out",
      "Not interested",
      "What's blockchain?"
    ],
  },
  {
    label: "How much would you be willing to pay for this service*?",
    type: "radio",
    name: "price",
    options: ["$10 - $15", "$16 - $20", "$21 - $25", "$26 - $30"],
  },
  {
    label: "Which feature sounds most appealing to you*?",
    type: "checkbox",
    name: "features",
    options: [
      "Seeing all achievements in one place",
      "NFT rare achievements you actually own",
      "Sharing complete gaming profile with friends",
      "Using it to log into new games"
    ],
  },
  {
    label: "What's your age range*?",
    type: "radio",
    name: "age",
    options: ["Under 18", "18-25", "26-35", "36-45", "46+"],
  },
  {
    label: "Where are you located*?",
    type: "radio",
    name: "location",
    options: ["North America (US/Canada)", "Europe", "Asia-Pacific", "South America", "Africa", "Other"],
    other: true,
  },
  {
    label: "How much do you typically spend on gaming per year*?",
    type: "radio",
    name: "spend",
    options: ["Under $100", "$100-300", "$300-600", "$600-1000", "Over $1000"],
  },
  {
    label: "What's your biggest frustration with current gaming platforms?",
    type: "text",
    name: "frustration",
    maxLength: 200,
  },
  {
    label: "What would make you excited to try OriginForge?",
    type: "text",
    name: "excited",
    maxLength: 200,
  },
  {
    label: "Any other thoughts or questions about unified gaming identity?",
    type: "text",
    name: "thoughts",
    maxLength: 300,
  },
  {
    label: "Want to be notified when OriginForge launches*?",
    type: "radio",
    name: "notify",
    options: ["Yes, keep me updated!", "No thanks"],
  },
  {
    label: "Email*:",
    type: "email",
    name: "email",
  },
  {
    type: "discord",
    name: "discord",
  },
];

const SurveySection: React.FC = () => {
  // Helper to submit answers to Supabase
  const [showShareCard, setShowShareCard] = useState(false);
  const submitSurvey = async () => {
    // Prepare answers for DB
    const payload = { ...answers, submitted_at: new Date().toISOString() };
    const { error } = await supabase.from('survey_responses').insert([payload]);
    if (error) {
      alert('Error submitting survey: ' + error.message);
    } else {
      setShowShareCard(true);
    }
  };
  const router = useRouter();
  const [step, setStep] = useState<number>(0);
  const [answers, setAnswers] = useState<{[key: string]: string | string[] | undefined}>({});
  // Removed unused showDiscord state
  // Discord popup state removed

  const current = questions[step];
  const isAnswered = useMemo(() => {
    if (current.type === 'discord') return true;
    const val = answers[current?.name];
    if (Array.isArray(val)) {
      return val.length > 0;
    }
    return val !== undefined && val !== '';
  }, [answers, current]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target;
    let checked = false;
    if (type === 'checkbox') {
      checked = (e.target as HTMLInputElement).checked;
      setAnswers(prev => {
        const arr = Array.isArray(prev[name]) ? [...prev[name]] : [];
        if (checked) {
          arr.push(value);
        } else {
          const idx = arr.indexOf(value);
          if (idx > -1) arr.splice(idx, 1);
        }
        return { ...prev, [name]: arr };
      });
    } else {
      setAnswers(prev => ({ ...prev, [name]: value }));
    }
  };

  return (
  <section className="relative flex flex-col items-center justify-center min-h-screen px-2 py-4 sm:px-4 sm:py-8" style={{backgroundImage: 'url(/bg.svg)', backgroundSize: 'cover', backgroundRepeat: 'no-repeat', backgroundPosition: 'center'}}>
    {/* Logo in top-left corner */}
    <div className="absolute top-0 left-0 z-20 p-2 sm:p-4">
       <button
         aria-label="Go to Hero Section"
         onClick={() => router.push('/#hero')}
         style={{ background: 'none', border: 'none', boxShadow: 'none', padding: 0, cursor: 'pointer' }}
       >
         <Image src="/logo.svg" alt="OriginForge Logo" width={64} height={64} className="w-12 h-12 sm:w-16 sm:h-16 object-contain cursor-pointer" priority />
       </button>
    </div>
  <div className="w-full max-w-md mx-auto relative z-30" style={{ boxShadow: '0 8px 32px 0 rgba(0,0,0,0.25)' }}>
      <form
        className="p-0 w-full flex flex-col gap-6 text-xs sm:text-base"
        style={{
          backgroundImage: 'url(/form.png)',
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          backgroundRepeat: 'no-repeat',
          borderRadius: '1rem',
        }}
        onSubmit={e => e.preventDefault()}
      >
          <div className="w-full flex justify-center items-center">
            <span
              className="bg-yellow-300 font-bold rounded shadow"
              style={{
                color: '#6b4f2c', // brown
                padding: '4px 16px',
                fontSize: '1.1rem',
                minWidth: '64px',
                textAlign: 'center',
                display: 'inline-block',
                marginTop: '16px',
              }}
            >
              {step + 1} / {questions.length}
            </span>
          </div>
        {/* Single Question Card */}
        <div className="flex flex-col gap-3">
          {/* Only show label if not email or not on share card */}
          {current.type !== 'email' && (
            <div className="font-press-start text-base sm:text-lg text-yellow-700 mb-2 drop-shadow" style={{ whiteSpace: 'normal', wordBreak: 'break-word', overflowWrap: 'break-word', textAlign: 'center' }}>{current.label}</div>
          )}
          {current.type === 'email' && !showShareCard && (
            <>
              <div className="font-press-start text-base sm:text-lg text-yellow-700 mb-2 drop-shadow">{current.label}</div>
              <input type="email" name={current.name} className="border-2 border-yellow-300 rounded-xl px-2 py-1 w-full bg-white text-yellow-900 focus:border-yellow-600" required value={answers[current.name] || ''} onChange={handleChange} />
            </>
          )}
          {current.type === 'email' && showShareCard && (
            <div className="font-press-start text-base sm:text-lg text-yellow-700 mb-2 drop-shadow text-center">
              No emails here, just good vibes and epic loot!
            </div>
          )}
          {current.type === 'radio' && current.options && (
            <div className="flex flex-col gap-2">
              {current.options.map(opt => {
                const checked = answers[current.name] === opt;
                return (
                  <label key={opt} className="flex items-center gap-2 px-2 py-1 rounded bg-white border border-yellow-200 hover:bg-yellow-100 cursor-pointer text-[#6b4f2c]">
                    <input
                      type="radio"
                      name={current.name}
                      value={opt}
                      checked={checked}
                      onChange={handleChange}
                      style={{ display: 'none' }}
                    />
                    {checked ? <RadioOn /> : <RadioOff />}
                    {opt}
                  </label>
                );
              })}
            </div>
          )}
          {current.type === 'checkbox' && current.options && (
            <div className="flex flex-col gap-2">
              {current.options.map(opt => {
                const checked = Array.isArray(answers[current.name]) && answers[current.name]?.includes(opt);
                return (
                  <label key={opt} className="flex items-center gap-2 px-2 py-1 rounded bg-white border border-yellow-200 hover:bg-yellow-100 cursor-pointer text-[#6b4f2c]">
                    <input
                      type="checkbox"
                      name={current.name}
                      value={opt}
                      checked={checked}
                      onChange={handleChange}
                      style={{ display: 'none' }}
                    />
                    {checked ? <CheckboxOn /> : <CheckboxOff />}
                    {opt}
                  </label>
                );
              })}
              {current.other && Array.isArray(answers[current.name]) && answers[current.name]?.includes('Other') && (
                <div className="pl-7 pt-2">
                  <input
                    type="text"
                    className="pixel-border border-2 border-yellow-400 rounded-xl px-4 py-3 bg-[#23232b] text-yellow-100 focus:border-yellow-600 font-press-start text-xs sm:text-sm placeholder-yellow-400 shadow w-[260px] sm:w-[320px] h-[44px] sm:h-[52px]"
                    placeholder="Type your answer..."
                    name={current.name + '_other'}
                    value={answers[current.name + '_other'] || ''}
                    onChange={handleChange}
                    maxLength={40}
                  />
                </div>
              )}
            </div>
          )}
          {current.type === 'text' && (
            <textarea maxLength={current.maxLength} className="border-2 border-yellow-300 rounded-xl px-2 py-1 w-full mb-2 bg-white text-yellow-900 focus:border-yellow-600" placeholder={`${current.maxLength} characters max`} name={current.name} value={answers[current.name] || ''} onChange={handleChange} />
          )}
          {current.type === 'discord' && (
            <div className="flex flex-col items-center justify-center py-12">
              <div className="mb-6 text-center font-press-start text-yellow-700 text-base sm:text-lg">Ready to level up your social XP? Our Discord is where the real loot drops!</div>
              <button type="button" className="pixel-button bg-blue-600 text-white px-8 py-4 rounded shadow text-lg font-press-start" onClick={() => window.open('https://discord.gg/your-discord-link', '_blank')}>Join Discord</button>
            </div>
          )}
        </div>
        {/* Navigation Arrows */}
        {current.type !== 'discord' && (
          showShareCard ? (
            <div className="flex flex-col gap-4 items-center justify-center mt-8 mb-8">
              <button
                type="button"
                className="pixel-button px-6 py-4 bg-blue-600 text-white rounded border-2 border-blue-700 shadow w-full max-w-xs font-bold text-lg"
                onClick={() => {
                  const tweetText = encodeURIComponent('I just completed the OriginForge survey! Check it out and help shape the future of gaming achievements. #OriginForge #Survey https://originforge.games');
                  window.open(`https://twitter.com/intent/tweet?text=${tweetText}`, '_blank');
                }}
              >Share it on X!</button>
              <button
                type="button"
                className="pixel-button px-6 py-4 bg-purple-600 text-white rounded border-2 border-purple-700 shadow w-full max-w-xs font-bold text-lg"
                onClick={() => window.open('https://discord.gg/your-discord-link', '_blank')}
              >Join Discord</button>
            </div>
          ) : (
            <div className="flex justify-between mt-4 pb-4">
              <button type="button" disabled={step === 0} onClick={() => setStep(s => Math.max(0, s-1))} style={{ background: 'none', border: 'none', boxShadow: 'none', padding: 0, margin: '0 16px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                <Image src="/previous.png" alt="Previous" width={180} height={60} style={{ height: 'auto', boxShadow: 'none', background: 'none', display: 'block' }} />
              </button>
              {step === questions.length - 2 ? (
                <button
                  type="button"
                  disabled={!isAnswered}
                  onClick={submitSurvey}
                  style={{ background: 'none', border: 'none', boxShadow: 'none', padding: 0, margin: '0 16px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}
                >
                  <Image src="/submit.png" alt="Submit" width={180} height={60} style={{ height: 'auto', boxShadow: 'none', background: 'none', display: 'block' }} />
                </button>
              ) : (
                <button
                  type="button"
                  disabled={!isAnswered || step === questions.length-1}
                  onClick={() => {
                    setStep(s => Math.min(questions.length-1, s+1));
                  }}
                  style={{ background: 'none', border: 'none', boxShadow: 'none', padding: 0, margin: '0 16px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}
                >
                  <Image src="/next.png" alt="Next" width={180} height={60} style={{ height: 'auto', boxShadow: 'none', background: 'none', display: 'block' }} />
                </button>
              )}
            </div>
          )
        )}
      </form>
    </div>
  </section>
  );
};

export default SurveySection;
